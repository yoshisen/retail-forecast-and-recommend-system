# イオン連鎖スーパーマーケット分析システム - プロジェクト仕様書

## 📋 初期 Assumptions

### A1: データと環境
- **A1.1** タイムゾーン: Asia/Tokyo（日本標準時）
- **A1.2** Excelファイルサイズ: < 50MB（推奨）、最大100MB
- **A1.3** TransactionItems 最大行数: 200万行（分块読取対応）
- **A1.4** 最低限必要なSheet: TransactionItems + Product
- **A1.5** データ期間: 最低3ヶ月、推奨6ヶ月以上

### A2: 性能要件
- **A2.1** Excel解析時間: < 30秒（50MB以内）
- **A2.2** 初回モデル訓練: < 60秒
- **A2.3** 予測レスポンス: < 2秒（単一商品）、< 10秒（バッチ100件）
- **A2.4** 推薦レスポンス: < 1秒（顧客あたり）
- **A2.5** 同時接続: 10ユーザー（初版）

### A3: 機能優先度
- **A3.1** P0必須: 販売予測（基線+LightGBM）+ 協同フィルタリング推薦
- **A3.2** P1重要: プロモーション影響分析 + 在庫最適化
- **A3.3** P2拡張: What-ifシミュレーション + 異常検知
- **A3.4** P3将来: 高度な時系列モデル + グラフ埋め込み

### A4: データ品質
- **A4.1** 欠損率許容範囲: フィールドレベル < 30%（警告）、< 60%（除外）
- **A4.2** 重複主键: 最新レコード保持
- **A4.3** 異常値: IQR方式で検出、訓練から除外
- **A4.4** 冷启动顧客: 全体の推定20%

### A5: セキュリティとプライバシー
- **A5.1** PII保護: email/phoneはマスク表示
- **A5.2** ファイル保存: 解析後削除または暗号化保存
- **A5.3** マクロ: .xlsm拒否、VBA実行禁止
- **A5.4** アクセス制御: API Key認証（P1で実装）

---

## 🏗️ 総体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend Layer                          │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐ │
│  │ Upload Page  │  Dashboard   │  Forecast    │ Recommend    │ │
│  │  (質量報告)   │  (KPI可視化) │  (予測曲線)  │  (推薦列表)   │ │
│  └──────────────┴──────────────┴──────────────┴──────────────┘ │
│       React + Vite + TailwindCSS + Recharts + Ant Design       │
└─────────────────────────────────────────────────────────────────┘
                                 ↕ REST API
┌─────────────────────────────────────────────────────────────────┐
│                        Backend API Layer                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  FastAPI (Python 3.11+)                                  │  │
│  │  - /api/upload  /api/forecast  /api/recommend            │  │
│  │  - /api/inventory  /api/promotion  /api/anomalies        │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌────────────────┬──────────────────┬──────────────────────┐  │
│  │ Version Manager│  Cache Layer     │  Error Handler       │  │
│  │ (データ版本)    │  (Redis/Memory)  │  (降級策略)           │  │
│  └────────────────┴──────────────────┴──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                      Data Processing Layer                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Excel Parser & Validator                                │  │
│  │  - Sheet識別  - フィールド標準化  - 質量報告生成          │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌─────────────────┬────────────────────┬──────────────────┐  │
│  │ Feature Engine  │  Data Transformer  │  Quality Check   │  │
│  │ (特徴生成)       │  (標準化/Encoding) │  (異常検出)       │  │
│  └─────────────────┴────────────────────┴──────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                        Model Layer                              │
│  ┌─────────────────────┬──────────────────────────────────┐    │
│  │  Forecasting Models │    Recommendation Models         │    │
│  │  - Baseline (MA)    │    - Collaborative Filtering     │    │
│  │  - LightGBM         │    - Content-Based               │    │
│  │  - Prophet (P1)     │    - Association Rules           │    │
│  │  - Stratification   │    - Hybrid Scoring              │    │
│  └─────────────────────┴──────────────────────────────────┘    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Model Registry & Versioning                            │  │
│  │  - 訓練履歴  - パフォーマンスメトリクス  - A/B Testing   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                 ↕
┌─────────────────────────────────────────────────────────────────┐
│                      Storage Layer                              │
│  ┌─────────────────────┬──────────────────────────────────┐    │
│  │  DataFrame Cache    │    Model Artifacts               │    │
│  │  (Pandas/Polars)    │    (pickle/joblib)               │    │
│  │  Arrow/Parquet      │    Config YAML/JSON              │    │
│  └─────────────────────┴──────────────────────────────────┘    │
│  Optional: DuckDB (列指向クエリ) / SQLite (メタデータ)         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 P0 交付清单（MVP必須機能）

### 1. Excel アップロードと解析 ✅
- **1.1** ファイル受信とバリデーション（拡張子、サイズ、MIME）
- **1.2** Sheet自動識別（英語/日本語/中国語名対応）
- **1.3** フィールド標準化（camelCase、型推論）
- **1.4** データ質量報告生成（欠損率、重複、異常値、日付範囲）
- **1.5** データ字典自動生成

### 2. 基礎販売予測 🎯
- **2.1** 時系列特徴: dayOfWeek, month, lag_7/14/28
- **2.2** Baseline モデル: 移動平均 + 季節性調整
- **2.3** LightGBM モデル: product_id × store_id 階層
- **2.4** 評価指標: MAPE, RMSE, MAE
- **2.5** 予測API: 単一商品14日予測

### 3. 協同フィルタリング推薦 🎯
- **3.1** User-Item相互作用行列構築
- **3.2** ALS行列分解（implicit ライブラリ）
- **3.3** Top-K推薦生成
- **3.4** 冷启动処理: 人気商品 + カテゴリ多様性
- **3.5** 評価指標: Precision@10, Recall@10

### 4. 基本ダッシュボード 📊
- **4.1** アップロード進捗とステータス表示
- **4.2** データサマリーカード（総取引数、商品数、顧客数）
- **4.3** 販売トレンドグラフ（日次/週次/月次）
- **4.4** 商品別予測可視化
- **4.5** 顧客推薦リスト表示

### 5. REST API 基本エンドポイント 🔌
```
POST /api/v1/upload          - Excel アップロード
GET  /api/v1/data/summary    - データサマリー取得
GET  /api/v1/forecast        - 販売予測（単一）
POST /api/v1/forecast/batch  - 販売予測（バッチ）
GET  /api/v1/recommend       - 個別推薦
GET  /api/v1/recommend/popular - 人気商品推薦
GET  /api/v1/health          - ヘルスチェック
```

---

## 🛠️ 技術スタック

### Backend
- **言語**: Python 3.11+
- **Webフレームワーク**: FastAPI 0.104+
- **データ処理**: Pandas 2.1+, Polars 0.19+ (optional)
- **Excel解析**: openpyxl 3.1+, xlrd
- **機械学習**:
  - LightGBM 4.1+
  - scikit-learn 1.3+
  - implicit 0.7+ (協同フィルタリング)
  - mlxtend (関連規則)
- **時系列**: Prophet 1.1+ (P1)
- **キャッシュ**: cachetools / Redis (optional)
- **検証**: Pydantic 2.4+

### Frontend
- **フレームワーク**: React 18 + Vite 5
- **UI**: Ant Design 5 + TailwindCSS 3
- **可視化**: Recharts / Apache ECharts
- **状態管理**: Zustand / React Query
- **HTTPクライアント**: Axios

### DevOps
- **コンテナ**: Docker + Docker Compose
- **テスト**: pytest, pytest-cov, React Testing Library
- **Linting**: ruff (Python), ESLint (JS)
- **型チェック**: mypy, TypeScript

---

## 📦 P0 迭代ステップ（4週間計画）

### Week 1: データ基盤 🏗️
**目標**: Excelアップロードから質量報告まで

**Day 1-2: プロジェクト構造とExcel解析**
- プロジェクト構造作成（backend/frontend分離）
- Excel Parser実装（Sheet識別、型推論）
- テスト用Excel生成スクリプト更新

**Day 3-4: データバリデーションと標準化**
- フィールド標準化ロジック
- データ質量報告生成
- データ字典自動生成

**Day 5-7: APIとストレージ**
- FastAPI基本構造
- アップロードエンドポイント
- バージョン管理システム
- 単体テスト

### Week 2: 予測モデル 📈
**目標**: 基線+LightGBM予測モデル

**Day 8-10: 特徴エンジニアリング**
- 時系列特徴生成
- ラグ特徴とローリング統計
- カテゴリエンコーディング

**Day 11-13: モデル訓練**
- Baselineモデル（移動平均）
- LightGBM訓練パイプライン
- ハイパーパラメータ調整

**Day 14: 評価と統合**
- 評価指標計算
- 予測APIエンドポイント
- 統合テスト

### Week 3: 推薦システム 🎁
**目標**: 協同フィルタリング推薦

**Day 15-17: データ準備と行列構築**
- User-Item相互作用行列
- ALS行列分解実装
- 冷启动戦略

**Day 18-20: 推薦生成と評価**
- Top-K推薦生成
- 評価指標計算
- 推薦APIエンドポイント

**Day 21: 最適化**
- 推薦速度最適化
- キャッシング戦略
- テスト

### Week 4: フロントエンド 🎨
**目標**: MVP UI完成

**Day 22-24: コア画面**
- アップロードページ
- ダッシュボード（KPI表示）
- データ質量報告表示

**Day 25-27: 機能画面**
- 予測可視化ページ
- 推薦表示ページ
- エラーハンドリング

**Day 28: 統合とデプロイ**
- E2Eテスト
- Docker化
- ドキュメント整備
- デモデータ準備

---

## 🎯 Week 1 詳細タスク（現在実行中）

### Task 1.1: プロジェクト構造構築 ✅
```
dataAnalysisProject/
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py              # FastAPI エントリポイント
│   │   ├── config.py            # 設定管理
│   │   ├── api/
│   │   │   ├── v1/
│   │   │   │   ├── upload.py
│   │   │   │   ├── forecast.py
│   │   │   │   ├── recommend.py
│   │   ├── core/
│   │   │   ├── excel_parser.py   # Sheet識別とパース
│   │   │   ├── validator.py      # データバリデーション
│   │   │   ├── quality.py        # 質量報告生成
│   │   │   ├── feature_engine.py # 特徴生成
│   │   ├── models/
│   │   │   ├── forecasting.py    # 予測モデル
│   │   │   ├── recommendation.py # 推薦モデル
│   │   ├── schemas/              # Pydantic スキーマ
│   │   ├── utils/
│   │   └── tests/
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── services/
│   │   ├── App.jsx
│   │   └── main.jsx
│   ├── package.json
│   └── vite.config.js
├── data/
│   ├── uploaded/       # 一時アップロード
│   ├── processed/      # 処理済み
│   └── models/         # 保存モデル
├── tests/
│   └── test_data/
├── docker-compose.yml
└── README.md
```

---

## 🚀 実行戦略

**開発アプローチ**: 
1. **Phase 1**: 全コード一気に実装（テスト実行スキップ）
2. **Phase 2**: コード完成後に自己レビュー＆修正
3. **Phase 3**: 重点テスト項目リスト作成
4. **Phase 4**: 段階的テスト実行

**理由**: システム全体の整合性を保ちながら、高速で完成させる

---

## 📝 実装進行中...
